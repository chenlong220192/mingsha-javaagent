# mingsha-javaagent-methodtime

## ç®€ä»‹

mingsha-javaagent-methodtime æ˜¯ä¸€æ¬¾é«˜æ€§èƒ½ã€å¯é…ç½®ã€æ”¯æŒæ— æŸå¸è½½çš„ Java Agentï¼Œä¸“æ³¨äºæ–¹æ³•çº§åˆ«çº³ç§’çº§è€—æ—¶é‡‡é›†ï¼Œæ•°æ®å­˜å…¥ H2 æ•°æ®åº“ï¼Œå¹¶æä¾›å®‰å…¨çš„ Telnet ç®¡ç†æœåŠ¡ã€‚

## ä¸»è¦ç‰¹æ€§
- é›¶å¹²æ‰°ã€é›¶ä¸­æ–­ï¼Œä¸»è¿›ç¨‹å®‰å…¨
- çº³ç§’çº§æ–¹æ³•è€—æ—¶é‡‡é›†ï¼Œæ”¯æŒé‡‡æ ·ç‡ã€åŒ…èŒƒå›´ã€æœ€å°é˜ˆå€¼ç­‰å¤šç»´åº¦é…ç½®
- **è‡ªåŠ¨å»ºåº“å»ºè¡¨**ï¼šé¦–æ¬¡å¯åŠ¨è‡ªåŠ¨åˆ›å»ºæ•°æ®åº“æ–‡ä»¶å’Œå®Œæ•´è¡¨ç»“æ„
- **è‡ªåŠ¨æ±‡æ€»ç»Ÿè®¡**ï¼šå®æ—¶è®¡ç®—å„æ–¹æ³•çš„è°ƒç”¨æ¬¡æ•°ã€å¹³å‡è€—æ—¶ç­‰ç»Ÿè®¡ä¿¡æ¯
- **è‡ªåŠ¨æ…¢æŸ¥è¯¢è¯†åˆ«**ï¼šè‡ªåŠ¨è¯†åˆ«å¹¶è®°å½•è¶…è¿‡é˜ˆå€¼çš„æ…¢æŸ¥è¯¢
- æ•°æ®æ‰¹é‡å†™å…¥ H2ï¼Œå¤±è´¥è‡ªåŠ¨è½¬å­˜æœ¬åœ°ï¼Œæ”¯æŒè‡ªåŠ¨è¡¥å¿
- ä¸°å¯Œçš„Telnetç®¡ç†å‘½ä»¤ï¼Œæ”¯æŒAgentç®¡ç†ã€æ•°æ®åº“æŸ¥è¯¢ã€ç»Ÿè®¡ä¿¡æ¯ç­‰
- çº¿ç¨‹å¥åº·è‡ªæ„ˆã€CPUç†”æ–­ã€è‡ªåŠ¨æ¸…ç†å†å²æ•°æ®
- å…¨å±€å¼‚å¸¸æ•è·ï¼Œå®‰å…¨å¯é 
- **å­—èŠ‚ç å¢å¼ºä¼˜åŒ–**ï¼šåŸºäº ASM 9.5ï¼Œæ”¯æŒ Java 8+ï¼Œè‡ªåŠ¨æ ˆå¸§è®¡ç®—ï¼Œå…¼å®¹æ€§æ›´å¥½

## ğŸ“š æ–‡æ¡£å¯¼èˆª

### ğŸš€ å¿«é€Ÿå…¥é—¨
- **[00-å¿«é€Ÿå¼€å§‹](docs/00-å¿«é€Ÿå¼€å§‹.md)** - 5åˆ†é’Ÿå¿«é€Ÿä¸Šæ‰‹æŒ‡å—ï¼ŒåŒ…å«ç¯å¢ƒå‡†å¤‡ã€å®‰è£…é…ç½®ã€åŸºæœ¬ä½¿ç”¨ã€é…ç½®è¯´æ˜ã€Telnetå‘½ä»¤ã€æ•°æ®è¡¨ç»“æ„

### âš™ï¸ æ¶æ„è®¾è®¡
- **[01-æ¶æ„è®¾è®¡](docs/01-æ¶æ„è®¾è®¡.md)** - ç³»ç»Ÿæ•´ä½“æ¶æ„è®¾è®¡å’Œæ¨¡å—è¯´æ˜

### ğŸ”§ æŠ€æœ¯åŸºç¡€
- **[02-æŠ€æœ¯æ ˆæ¦‚è§ˆ](docs/02-æŠ€æœ¯æ ˆæ¦‚è§ˆ.md)** - é¡¹ç›®æŠ€æœ¯æ ˆä»‹ç»å’Œé€‰å‹è¯´æ˜
- **[03-ASMå­—èŠ‚ç å¢å¼ºæŠ€æœ¯](docs/03-ASMå­—èŠ‚ç å¢å¼ºæŠ€æœ¯.md)** - æ ¸å¿ƒæŠ€æœ¯åŸç†è¯¦è§£
- **[04-H2æ•°æ®åº“æŠ€æœ¯](docs/04-H2æ•°æ®åº“æŠ€æœ¯.md)** - å­˜å‚¨æŠ€æœ¯è¯¦è§£å’Œä¼˜åŒ–
- **[05-æµ‹è¯•æŠ€æœ¯æ ˆ](docs/05-æµ‹è¯•æŠ€æœ¯æ ˆ.md)** - æµ‹è¯•æŠ€æœ¯ä»‹ç»å’Œæœ€ä½³å®è·µ

### ğŸ“– ä½¿ç”¨æŒ‡å—
- **[06-é…ç½®è¦†ç›–æŒ‡å—](docs/é…ç½®è¦†ç›–æŒ‡å—.md)** - é€šè¿‡JVMç³»ç»Ÿå±æ€§è¦†ç›–é…ç½®çš„è¯¦ç»†è¯´æ˜
- **[07-APIæ¥å£](docs/07-APIæ¥å£.md)** - Telnetç®¡ç†æ¥å£å’ŒSQLæŸ¥è¯¢æ¥å£è¯¦ç»†è¯´æ˜
- **[08-ä½¿ç”¨ç¤ºä¾‹](docs/08-ä½¿ç”¨ç¤ºä¾‹.md)** - ä¸åŒåœºæ™¯çš„é…ç½®ç¤ºä¾‹å’Œæœ€ä½³å®è·µ
- **[09-éƒ¨ç½²æŒ‡å—](docs/09-éƒ¨ç½²æŒ‡å—.md)** - å¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ–¹æ¡ˆ
- **[10-ç›‘æ§æŒ‡æ ‡](docs/10-ç›‘æ§æŒ‡æ ‡.md)** - ç›‘æ§æŒ‡æ ‡ä½“ç³»ã€å‘Šè­¦è§„åˆ™å’Œé¢æ¿é…ç½®
- **[11-æ•…éšœæ’æŸ¥](docs/11-æ•…éšœæ’æŸ¥.md)** - å¸¸è§é—®é¢˜è¯Šæ–­ã€æ—¥å¿—åˆ†æå’Œè§£å†³æ–¹æ¡ˆ

### ğŸ‘¨â€ğŸ’» å¼€å‘æ–‡æ¡£
- **[12-å¼€å‘æŒ‡å—](docs/12-å¼€å‘æŒ‡å—.md)** - ä»£ç è´¡çŒ®è§„èŒƒã€æ’ä»¶å¼€å‘å’Œæµ‹è¯•æŒ‡å—
- **[13-æ€§èƒ½åŸºå‡†æµ‹è¯•](docs/13-æ€§èƒ½åŸºå‡†æµ‹è¯•.md)** - æ€§èƒ½æµ‹è¯•ç»“æœã€å‹åŠ›æµ‹è¯•å’Œä¼˜åŒ–å»ºè®®

### ğŸ“” å˜æ›´æ—¥å¿—
- **[14-CHANGELOG](docs/14-CHANGELOG.md)** - ç‰ˆæœ¬å˜æ›´å†å²ã€å‡çº§æŒ‡å—å’Œå…¼å®¹æ€§è¯´æ˜

### ğŸ¨ èµ„æºæ–‡ä»¶
- **[æ€»ä½“æ¶æ„è®¾è®¡å›¾](docs/img/æ€»ä½“æ¶æ„è®¾è®¡å›¾.svg)** - ç³»ç»Ÿæ¶æ„å¯è§†åŒ–å›¾è¡¨

---

## å¿«é€Ÿå¼€å§‹

> ğŸ“– **è¯¦ç»†çš„ä½¿ç”¨æŒ‡å—è¯·æŸ¥çœ‹ [00-å¿«é€Ÿå¼€å§‹](docs/00-å¿«é€Ÿå¼€å§‹.md)**

### 1. æ‰“åŒ…
```bash
make package
```

### 2. å¯åŠ¨åº”ç”¨ï¼ˆé»˜è®¤é…ç½®ï¼‰
```bash
java -javaagent:target/mingsha-javaagent-methodtime-0.0.1-SNAPSHOT.jar -jar your-app.jar
```

### 3. å¯åŠ¨åº”ç”¨ï¼ˆè‡ªå®šä¹‰é…ç½®ï¼‰
```bash
java -javaagent:target/mingsha-javaagent-methodtime-0.0.1-SNAPSHOT.jar \
     -Dmingsha.agent.config.collector.packages="com.myapp.* "\
     -Dmingsha.agent.config.collector.samplingRate=0.5 \
     -Dmingsha.agent.config.storage.h2.path="./my_app_db" \
     -jar your-app.jar
```

### 4. è¿æ¥ç®¡ç†
```bash
telnet localhost 5005
```

### 5. æŸ¥çœ‹çŠ¶æ€
```bash
agent status
```

### 6. æŸ¥çœ‹å¸®åŠ©
```bash
help
```

### 7. æŸ¥çœ‹æ•°æ®åº“ç»Ÿè®¡
```bash
db stats
```

### 8. æµ‹è¯•è‡ªåŠ¨å»ºåº“å»ºè¡¨
```bash
./bin/test-auto-db.sh
```

### 9. æµ‹è¯•é…ç½®è¦†ç›–
```bash
./bin/test-config-override.sh
```

### 10. æµ‹è¯•Telnetå‘½ä»¤
```bash
./bin/test-telnet-commands.sh
```

## æ€§èƒ½ä¸å®‰å…¨è¯´æ˜
- é‡‡é›†çº¿ç¨‹ã€å†™å…¥çº¿ç¨‹ã€Telnetçº¿ç¨‹ã€ç›‘æ§çº¿ç¨‹å‡ç‹¬ç«‹ï¼Œä¸»è¿›ç¨‹é›¶å¹²æ‰°
- æ”¯æŒæ‰¹é‡å†™å…¥ã€è‡ªåŠ¨è¡¥å¿ã€è‡ªåŠ¨æ¸…ç†ã€CPU ç†”æ–­ã€çº¿ç¨‹è‡ªæ„ˆ
- å…¨å±€å¼‚å¸¸æ•è·ï¼Œä¿è¯ä¸»è¿›ç¨‹ç¨³å®š
- Telnet ç«¯å£å†²çªè‡ªåŠ¨åˆ‡æ¢ï¼ŒSQL æ²™ç®±é˜²æ³¨å…¥

## å¸¸è§é—®é¢˜ä¸FAQ
- **å¦‚ä½•åŠ¨æ€è°ƒæ•´é‡‡æ ·ç‡/é‡‡é›†åŒ…ï¼Ÿ**
  - ä¿®æ”¹ agent-config.yml åï¼Œé€šè¿‡ Telnet æ‰§è¡Œ `agent reload` å³å¯çƒ­åŠ è½½ã€‚
- **å¦‚ä½•é€šè¿‡JVMå‚æ•°è¦†ç›–é…ç½®ï¼Ÿ**
  - ä½¿ç”¨ `-Dmingsha.agent.config.xxx=value` å‚æ•°ï¼Œå¦‚ `-Dmingsha.agent.config.collector.samplingRate=0.5`ã€‚
- **æ•°æ®åº“ä¼šè‡ªåŠ¨åˆ›å»ºå—ï¼Ÿ**
  - æ˜¯çš„ï¼Œé¦–æ¬¡å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨åˆ›å»ºæ•°æ®åº“æ–‡ä»¶å’Œæ‰€æœ‰è¡¨ç»“æ„ï¼ˆä¸»è¡¨ã€æ±‡æ€»è¡¨ã€æ…¢æŸ¥è¯¢è¡¨ã€ç‰ˆæœ¬è¡¨ï¼‰ã€‚
- **å¦‚ä½•æŸ¥çœ‹æ•°æ®åº“ç»Ÿè®¡ä¿¡æ¯ï¼Ÿ**
  - Telnet æ‰§è¡Œ `db stats` æŸ¥çœ‹ä¸»è¡¨ã€æ±‡æ€»è¡¨ã€æ…¢æŸ¥è¯¢è¡¨çš„ç»Ÿè®¡ä¿¡æ¯ã€‚
- **å¦‚ä½•æŸ¥çœ‹æ‰€æœ‰è¡¨ç»“æ„ï¼Ÿ**
  - Telnet æ‰§è¡Œ `db schema` æŸ¥çœ‹æ‰€æœ‰è¡¨çš„è¯¦ç»†ç»“æ„ã€‚
- **å¦‚ä½•æŸ¥çœ‹æ…¢æŸ¥è¯¢è®°å½•ï¼Ÿ**
  - Telnet æ‰§è¡Œ `select * from method_time_stat_slow order by duration_ns desc limit 10`ã€‚
- **å¦‚ä½•æŸ¥çœ‹æ–¹æ³•æ±‡æ€»ç»Ÿè®¡ï¼Ÿ**
  - Telnet æ‰§è¡Œ `select * from method_time_stat_summary order by total_calls desc limit 10`ã€‚
- **å¦‚ä½•å¯¼å‡ºé‡‡é›†æ•°æ®ï¼Ÿ**
  - Telnet æ‰§è¡Œ `agent export /tmp/out.csv`ã€‚
- **å¦‚ä½•ä¿è¯æ•°æ®ä¸ä¸¢å¤±ï¼Ÿ**
  - æ”¯æŒæœ¬åœ°è½¬å­˜ä¸è‡ªåŠ¨è¡¥å¿ï¼Œå¼‚å¸¸å¯é€šè¿‡ `agent errors` æŸ¥è¯¢ã€‚
- **å¦‚ä½•æ‰©å±•é‡‡é›†å­—æ®µï¼Ÿ**
  - ä¿®æ”¹ MethodTimeRecord åŠè¡¨ç»“æ„ï¼Œé‡å¯ agentã€‚
