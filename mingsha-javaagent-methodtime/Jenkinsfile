pipeline {
    agent { label 'linux' }

    tools {
        jdk 'jdk17'
    }

    environment {
        MAVEN_OPTS = '-Dmaven.test.failure.ignore=false'
        EMAIL_RECIPIENTS = 'dev-team@example.com'
        EMAIL_SUBJECT = '[æ„å»ºé€šçŸ¥] mingsha-javaagent-methodtime #${BUILD_NUMBER} - ${BUILD_STATUS}'
        EMAIL_BODY = '''
            <h3>Jenkins æ„å»ºé€šçŸ¥</h3>
            <ul>
                <li>é¡¹ç›®: mingsha-javaagent-methodtime</li>
                <li>æ„å»ºç¼–å·: ${BUILD_NUMBER}</li>
                <li>çŠ¶æ€: ${BUILD_STATUS}</li>
                <li>åˆ†æ”¯: ${GIT_BRANCH}</li>
                <li>æäº¤: ${GIT_COMMIT}</li>
                <li>è¯¦æƒ…: <a href="${BUILD_URL}">${BUILD_URL}</a></li>
            </ul>
        '''
        NUM_TO_KEEP = 1
        SKIP_TESTS = "${params.SKIP_TESTS ?: 'false'}"
    }

    options {
        buildDiscarder(logRotator(numToKeepStr: env.NUM_TO_KEEP))
        parameters([
            booleanParam(
                name: 'SKIP_TESTS',
                defaultValue: false,
                description: 'æ˜¯å¦è·³è¿‡æµ‹è¯•'
            )
        ])
    }

    stages {
        stage('Test') {
            when {
                expression { return env.SKIP_TESTS == 'false' }
            }
            steps {
                echo "ğŸ§ª æ‰§è¡Œå•å…ƒæµ‹è¯•..."
                sh './mvnw test'
            }
        }
        stage('Package') {
            steps {
                echo "ğŸ“¦ å¼€å§‹æ‰“åŒ…..."
                sh "./mvnw package -DskipTests=${env.SKIP_TESTS}"
            }
        }
        stage('Archive Artifacts') {
            steps {
                echo "ğŸ“¦ å½’æ¡£æ„å»ºäº§ç‰©..."
                archiveArtifacts artifacts: 'target/*.jar', fingerprint: true
            }
        }
    }

    post {
        always {
            script {
                echo "ğŸ§¹ æ¸…ç†å·¥ä½œç©ºé—´..."
                cleanWs()
            }
        }
        success {
            script {
                echo "ğŸ‰ æ„å»ºæˆåŠŸï¼"
                emailext(
                    to: env.EMAIL_RECIPIENTS,
                    subject: env.EMAIL_SUBJECT.replace('${BUILD_STATUS}', 'æˆåŠŸ'),
                    body: env.EMAIL_BODY.replace('${BUILD_STATUS}', 'æˆåŠŸ'),
                    mimeType: 'text/html'
                )
            }
        }
        failure {
            script {
                echo "âŒ æ„å»ºå¤±è´¥ï¼"
                emailext(
                    to: env.EMAIL_RECIPIENTS,
                    subject: env.EMAIL_SUBJECT.replace('${BUILD_STATUS}', 'å¤±è´¥'),
                    body: env.EMAIL_BODY.replace('${BUILD_STATUS}', 'å¤±è´¥'),
                    mimeType: 'text/html'
                )
            }
        }
        aborted {
            script {
                echo "â¹ï¸  æ„å»ºè¢«ä¸­æ­¢ï¼"
                emailext(
                    to: env.EMAIL_RECIPIENTS,
                    subject: env.EMAIL_SUBJECT.replace('${BUILD_STATUS}', 'ä¸­æ­¢'),
                    body: env.EMAIL_BODY.replace('${BUILD_STATUS}', 'ä¸­æ­¢'),
                    mimeType: 'text/html'
                )
            }
        }
    }
}
