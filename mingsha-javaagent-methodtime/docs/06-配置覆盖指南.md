# 配置覆盖指南

## 概述

mingsha-javaagent-methodtime 支持通过 JVM 系统属性覆盖默认配置，无需修改内置的 `agent-config.yml` 文件。这种方式特别适用于：

- 不同环境使用不同配置
- 临时调整配置参数
- 容器化部署时的配置管理
- 避免修改 jar 包内容

## 配置覆盖方式

### 1. JVM 系统属性覆盖（推荐）

在启动应用时通过 `-D` 参数指定配置：

```bash
java -javaagent:mingsha-javaagent-methodtime-1.0.0.jar \
     -Dmingsha.agent.config.collector.packages="com.myapp.* "\
     -Dmingsha.agent.config.collector.samplingRate=0.5 \
     -Dmingsha.agent.config.storage.h2.path="./my_app_db" \
     -Dmingsha.agent.config.manage.telnet.port=5006 \
     -jar your-application.jar
```

### 2. 环境变量方式

也可以通过环境变量设置（需要转换为系统属性）：

```bash
export MINGSHA_AGENT_CONFIG_COLLECTOR_PACKAGES="com.myapp.*"
export MINGSHA_AGENT_CONFIG_SAMPLING_RATE="0.5"
java -javaagent:mingsha-javaagent-methodtime-1.0.0.jar \
     -Dmingsha.agent.config.collector.packages=$MINGSHA_AGENT_CONFIG_COLLECTOR_PACKAGES \
     -Dmingsha.agent.config.collector.samplingRate=$MINGSHA_AGENT_CONFIG_SAMPLING_RATE \
     -jar your-application.jar
```

## 支持的配置项

### 采集相关配置

| 配置项 | 系统属性名 | 默认值 | 说明 |
|--------|------------|--------|------|
| 采集包范围 | `mingsha.agent.config.collector.packages` | `com.example.*` | 支持通配符，多个用逗号分隔 |
| 采样率 | `mingsha.agent.config.collector.samplingRate` | `1.0` | 0~1之间，1.0为全量采集 |
| 最小耗时阈值 | `mingsha.agent.config.collector.minDurationNs` | `100000` | 纳秒，低于此值不采集 |
| 缓冲队列容量 | `mingsha.agent.config.collector.queueCapacity` | `10000` | 条数，高峰期最大缓存量 |

### 存储相关配置

| 配置项 | 系统属性名 | 默认值 | 说明 |
|--------|------------|--------|------|
| 批量写入条数 | `mingsha.agent.config.storage.batchSize` | `500` | 越大写入效率越高 |
| 转存阈值 | `mingsha.agent.config.storage.failoverThreshold` | `2000` | 写入失败转存阈值 |
| 数据留存天数 | `mingsha.agent.config.storage.retentionDays` | `7` | 自动清理过期数据 |
| 数据留存条数 | `mingsha.agent.config.storage.retentionRows` | `1000000` | 超量自动清理 |
| H2数据库路径 | `mingsha.agent.config.storage.h2.path` | `./mingsha_javaagent_method_time_h2_db` | 数据库文件路径 |

### 管理相关配置

| 配置项 | 系统属性名 | 默认值 | 说明 |
|--------|------------|--------|------|
| Telnet端口 | `mingsha.agent.config.manage.telnet.port` | `5005` | 管理端口，支持自动切换 |
| Telnet最大线程 | `mingsha.agent.config.manage.telnet.maxThreads` | `1` | 并发管理连接数 |

### 监控相关配置

| 配置项 | 系统属性名 | 默认值 | 说明 |
|--------|------------|--------|------|
| CPU熔断阈值 | `mingsha.agent.config.monitor.cpu.fuseThreshold` | `80` | 百分比，超限暂停采集 |
| 健康检查间隔 | `mingsha.agent.config.monitor.healthCheckIntervalMs` | `5000` | 毫秒，建议5000~10000 |

### 日志配置

| 配置项 | 系统属性名 | 默认值 | 说明 |
|--------|------------|--------|------|
| 日志级别 | `mingsha.agent.config.log.level` | `INFO` | INFO/DEBUG/ERROR |

## 使用示例

### 示例1：生产环境配置

```bash
java -javaagent:mingsha-javaagent-methodtime-1.0.0.jar \
     -Dmingsha.agent.config.collector.packages="com.production.* "\
     -Dmingsha.agent.config.collector.samplingRate=0.1 \
     -Dmingsha.agent.config.collector.minDurationNs=1000000 \
     -Dmingsha.agent.config.storage.h2.path="/data/mingsha_javaagent_method_time_h2_db" \
     -Dmingsha.agent.config.storage.retentionDays=30 \
     -Dmingsha.agent.config.manage.telnet.port=5005 \
     -Dmingsha.agent.config.log.level=INFO \
     -jar production-app.jar
```

### 示例2：开发环境配置

```bash
java -javaagent:mingsha-javaagent-methodtime-1.0.0.jar \
     -Dmingsha.agent.config.collector.packages="com.dev.* "\
     -Dmingsha.agent.config.collector.samplingRate=1.0 \
     -Dmingsha.agent.config.collector.minDurationNs=100000 \
     -Dmingsha.agent.config.storage.h2.path="./dev_mingsha_javaagent_method_time_h2_db" \
     -Dmingsha.agent.config.storage.retentionDays=1 \
     -Dmingsha.agent.config.manage.telnet.port=5006 \
     -Dmingsha.agent.config.log.level=DEBUG \
     -jar dev-app.jar
```

### 示例3：性能测试配置

```bash
java -javaagent:mingsha-javaagent-methodtime-1.0.0.jar \
     -Dmingsha.agent.config.collector.packages="com.performance.* "\
     -Dmingsha.agent.config.collector.samplingRate=0.01 \
     -Dmingsha.agent.config.collector.minDurationNs=10000000 \
     -Dmingsha.agent.config.storage.batchSize=1000 \
     -Dmingsha.agent.config.storage.h2.path="./perf_mingsha_javaagent_method_time_h2_db" \
     -Dmingsha.agent.config.monitor.cpu.fuseThreshold=90 \
     -jar performance-test.jar
```

## 配置优先级

配置读取优先级（从高到低）：

1. **JVM 系统属性**：`-Dmingsha.agent.config.xxx=value`
2. **内置 YAML 配置**：`agent-config.yml`

## 配置验证

Agent 启动时会自动打印当前使用的配置信息：

```
[mingsha-agent] Current Configuration:
  Collector Packages: com.myapp.*
  Sampling Rate: 0.5
  Min Duration (ns): 100000
  Queue Capacity: 10000
  Batch Size: 500
  H2 Path: ./my_app_db
  Telnet Port: 5006
  CPU Fuse Threshold: 80%
  Log Level: INFO
```

## 注意事项

1. **系统属性优先级最高**：通过 `-D` 参数设置的配置会覆盖内置 YAML 配置
2. **类型自动转换**：系统属性值会根据配置项类型自动转换（字符串、数字、布尔值）
3. **错误处理**：如果系统属性值格式错误，会使用默认值
4. **路径配置**：H2数据库路径支持相对路径和绝对路径
5. **端口冲突**：如果Telnet端口被占用，Agent会自动选择其他可用端口

## 最佳实践

1. **环境分离**：为不同环境（开发、测试、生产）准备不同的启动脚本
2. **配置文档化**：将配置参数记录在部署文档中
3. **监控配置**：定期检查配置是否生效
4. **备份配置**：重要配置变更前做好备份
5. **逐步调整**：性能相关配置建议逐步调整，观察效果
