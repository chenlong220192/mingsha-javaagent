# 技术栈概览

## 项目简介

mingsha-javaagent-methodtime 是一个高性能的 Java Agent 方法耗时采集工具，采用字节码增强技术实现纳秒级方法耗时监控，支持 H2 数据库存储和 Telnet 远程管理。

## 核心技术栈

### 1. Java Agent 技术
- **Java Instrumentation API**: 实现字节码增强的核心 API
- **ASM 9.5**: 高性能字节码操作框架，用于动态修改类字节码
- **字节码增强**: 在方法入口和出口插入耗时统计代码

### 2. 数据库技术
- **H2 Database 2.2.224**: 轻量级嵌入式数据库
  - 支持内存模式和文件模式
  - 自动建表和索引优化
  - 支持 SQL 查询和 CSV 导出
  - 配置化的数据库路径管理

### 3. 网络通信
- **Telnet 协议**: 实现远程管理接口
- **Socket 编程**: 多线程 Socket 服务器
- **线程池**: 使用 ExecutorService 管理连接

### 4. 配置管理
- **SnakeYAML 2.2**: YAML 配置文件解析
- **动态配置**: 支持热加载配置变更
- **配置验证**: 类型安全的配置读取

### 5. 并发与线程管理
- **ArrayBlockingQueue**: 线程安全的内存缓冲队列
- **Thread Guardian**: 线程健康守护机制
- **线程自愈**: 异常线程自动重启
- **CPU 熔断**: 基于 CPU 使用率的采集控制

### 6. 监控与健康检查
- **系统监控**: CPU、内存使用率监控
- **数据丢失统计**: 队列满时的数据丢失监控
- **健康检查**: 定期检查各组件状态

### 7. 测试技术栈
- **JUnit 5.10.2**: 现代单元测试框架
- **Mockito 4.11.0**: Mock 测试框架
- **JaCoCo 0.8.11**: 代码覆盖率统计
- **JMH 1.37**: Java 微基准测试
- **TestContainers 1.19.3**: 容器化集成测试
- **Awaitility 4.2.0**: 异步测试支持

### 8. 构建与部署
- **Maven 3.x**: 项目构建和依赖管理
- **Maven Plugins**: 
  - maven-jar-plugin: Java Agent 打包
  - maven-surefire-plugin: 单元测试执行
  - maven-failsafe-plugin: 集成测试执行
  - maven-source-plugin: 源码打包
  - maven-javadoc-plugin: 文档生成

## 架构特点

### 1. 零侵入性
- 通过字节码增强实现，无需修改业务代码
- 支持 premain 和 agentmain 两种启动方式
- 主进程零干扰，异常隔离

### 2. 高性能
- 纳秒级精度采集
- 内存缓冲队列减少 I/O 开销
- 批量写入数据库提升性能
- CPU 熔断机制保护主进程

### 3. 高可用性
- 线程自愈机制
- 数据失败转存本地文件
- 自动补偿机制保证数据完整性
- 无损卸载保证数据不丢失

### 4. 可观测性
- 实时监控 CPU、内存使用率
- 数据丢失统计和告警
- Telnet 远程管理和查询
- CSV 数据导出功能

### 5. 可配置性
- YAML 配置文件支持
- 动态热加载配置
- 多环境配置支持
- 参数化数据库路径

## 技术选型理由

### 1. 为什么选择 ASM？
- **性能优势**: ASM 是字节码操作性能最好的框架
- **功能完整**: 支持所有 Java 字节码操作
- **社区活跃**: 持续维护和更新
- **学习资源丰富**: 文档和示例完善

### 2. 为什么选择 H2？
- **轻量级**: 无需额外安装，嵌入式运行
- **性能优秀**: 内存数据库性能优异
- **功能完整**: 支持标准 SQL 和高级特性
- **易于部署**: 单文件部署，无外部依赖

### 3. 为什么选择 Telnet？
- **简单可靠**: 协议简单，实现稳定
- **跨平台**: 所有操作系统都支持
- **调试友好**: 可以直接使用 telnet 命令连接
- **轻量级**: 无需额外的客户端软件

### 4. 为什么选择 YAML 配置？
- **可读性强**: 层次结构清晰，易于理解
- **支持复杂类型**: 支持列表、映射等复杂结构
- **注释支持**: 可以添加配置说明
- **标准化**: 广泛使用的配置格式

## 技术演进方向

### 1. 短期优化
- 支持更多数据库类型（MySQL、PostgreSQL）
- 增加 Web 管理界面
- 支持分布式部署和数据聚合

### 2. 中期规划
- 集成 Prometheus 指标导出
- 支持 OpenTelemetry 标准
- 增加机器学习异常检测

### 3. 长期愿景
- 云原生部署支持
- 多语言 Agent 支持
- 智能性能优化建议 