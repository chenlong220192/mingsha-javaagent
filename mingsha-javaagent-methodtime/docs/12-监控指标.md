# 监控指标文档

## 概述

本文档详细说明 mingsha-javaagent-methodtime 的监控指标体系，包括业务指标、系统指标、告警规则和监控面板配置。

## 监控指标体系

### 1. 业务指标

#### 1.1 方法调用指标
- **方法调用总数** (`method_calls_total`)
  - 描述: 采集到的方法调用总次数
  - 类型: Counter
  - 标签: `class_name`, `method_name`, `thread_name`
  - 单位: 次

- **方法平均耗时** (`method_duration_avg`)
  - 描述: 方法的平均执行时间
  - 类型: Gauge
  - 标签: `class_name`, `method_name`
  - 单位: 纳秒

- **方法最大耗时** (`method_duration_max`)
  - 描述: 方法的最大执行时间
  - 类型: Gauge
  - 标签: `class_name`, `method_name`
  - 单位: 纳秒

- **方法最小耗时** (`method_duration_min`)
  - 描述: 方法的最小执行时间
  - 类型: Gauge
  - 标签: `class_name`, `method_name`
  - 单位: 纳秒

#### 1.2 性能指标
- **慢方法数量** (`slow_methods_count`)
  - 描述: 超过阈值的慢方法数量
  - 类型: Gauge
  - 标签: `threshold_ms`
  - 单位: 个

- **方法调用频率** (`method_call_rate`)
  - 描述: 每秒方法调用次数
  - 类型: Gauge
  - 标签: `class_name`, `method_name`
  - 单位: 次/秒

- **性能趋势** (`performance_trend`)
  - 描述: 性能变化趋势（上升/下降/稳定）
  - 类型: Gauge
  - 标签: `class_name`, `method_name`
  - 单位: 趋势值

#### 1.3 数据质量指标
- **数据采集率** (`data_collection_rate`)
  - 描述: 实际采集数据与理论采集数据的比率
  - 类型: Gauge
  - 单位: 百分比

- **数据丢失率** (`data_loss_rate`)
  - 描述: 数据丢失的比率
  - 类型: Gauge
  - 单位: 百分比

- **数据完整性** (`data_integrity`)
  - 描述: 数据完整性检查结果
  - 类型: Gauge
  - 单位: 完整性分数

### 2. 系统指标

#### 2.1 Agent 系统指标
- **CPU 使用率** (`agent_cpu_usage`)
  - 描述: Agent 进程的 CPU 使用率
  - 类型: Gauge
  - 单位: 百分比

- **内存使用量** (`agent_memory_usage`)
  - 描述: Agent 进程的内存使用量
  - 类型: Gauge
  - 单位: 字节

- **线程数量** (`agent_thread_count`)
  - 描述: Agent 管理的线程数量
  - 类型: Gauge
  - 单位: 个

- **队列使用率** (`queue_usage_rate`)
  - 描述: 内存缓冲队列的使用率
  - 类型: Gauge
  - 单位: 百分比

#### 2.2 存储指标
- **数据库连接状态** (`db_connection_status`)
  - 描述: H2 数据库连接状态
  - 类型: Gauge
  - 值: 0=断开, 1=连接

- **数据库记录数** (`db_record_count`)
  - 描述: 数据库中的记录总数
  - 类型: Gauge
  - 单位: 条

- **数据库大小** (`db_size`)
  - 描述: 数据库文件大小
  - 类型: Gauge
  - 单位: 字节

- **写入成功率** (`write_success_rate`)
  - 描述: 数据写入成功率
  - 类型: Gauge
  - 单位: 百分比

#### 2.3 网络指标
- **Telnet 连接数** (`telnet_connections`)
  - 描述: 当前 Telnet 连接数
  - 类型: Gauge
  - 单位: 个

- **Telnet 请求数** (`telnet_requests_total`)
  - 描述: Telnet 请求总数
  - 类型: Counter
  - 标签: `command_type`

- **Telnet 响应时间** (`telnet_response_time`)
  - 描述: Telnet 命令响应时间
  - 类型: Histogram
  - 单位: 毫秒

### 3. 异常指标

#### 3.1 错误统计
- **采集异常数** (`collection_errors_total`)
  - 描述: 数据采集过程中的异常总数
  - 类型: Counter
  - 标签: `error_type`

- **写入异常数** (`write_errors_total`)
  - 描述: 数据写入过程中的异常总数
  - 类型: Counter
  - 标签: `error_type`

- **转存异常数** (`failover_errors_total`)
  - 描述: 数据转存过程中的异常总数
  - 类型: Counter
  - 标签: `error_type`

#### 3.2 熔断指标
- **CPU 熔断次数** (`cpu_fuse_count`)
  - 描述: CPU 熔断触发次数
  - 类型: Counter

- **熔断持续时间** (`fuse_duration`)
  - 描述: 熔断状态的持续时间
  - 类型: Gauge
  - 单位: 秒

- **熔断恢复次数** (`fuse_recovery_count`)
  - 描述: 熔断恢复次数
  - 类型: Counter

## 告警规则配置

### 1. Prometheus 告警规则

```yaml
# method_time_alerts.yml
groups:
  - name: method_time_alerts
    rules:
      # 1. 数据丢失告警
      - alert: HighDataLossRate
        expr: data_loss_rate > 0.05
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "数据丢失率过高"
          description: "数据丢失率超过5%，持续5分钟"

      # 2. 慢方法告警
      - alert: TooManySlowMethods
        expr: slow_methods_count > 10
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "慢方法数量过多"
          description: "慢方法数量超过10个，持续2分钟"

      # 3. CPU 使用率告警
      - alert: HighCPUUsage
        expr: agent_cpu_usage > 80
        for: 3m
        labels:
          severity: warning
        annotations:
          summary: "Agent CPU 使用率过高"
          description: "Agent CPU 使用率超过80%，持续3分钟"

      # 4. 内存使用率告警
      - alert: HighMemoryUsage
        expr: agent_memory_usage / agent_memory_limit > 0.9
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Agent 内存使用率过高"
          description: "Agent 内存使用率超过90%，持续5分钟"

      # 5. 队列满告警
      - alert: QueueFull
        expr: queue_usage_rate > 0.95
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "缓冲队列即将满"
          description: "缓冲队列使用率超过95%，持续1分钟"

      # 6. 数据库连接告警
      - alert: DatabaseConnectionLost
        expr: db_connection_status == 0
        for: 30s
        labels:
          severity: critical
        annotations:
          summary: "数据库连接丢失"
          description: "H2 数据库连接丢失，持续30秒"

      # 7. 写入失败告警
      - alert: HighWriteFailureRate
        expr: write_success_rate < 0.95
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "数据写入失败率过高"
          description: "数据写入成功率低于95%，持续2分钟"

      # 8. 熔断告警
      - alert: CPUFuseActive
        expr: cpu_fuse_count > 0
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "CPU 熔断已激活"
          description: "CPU 熔断机制已激活，数据采集已暂停"
```

### 2. 告警通知配置

```yaml
# alertmanager.yml
global:
  smtp_smarthost: 'smtp.company.com:587'
  smtp_from: 'alertmanager@company.com'
  smtp_auth_username: 'alertmanager@company.com'
  smtp_auth_password: 'password'

route:
  group_by: ['alertname']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  receiver: 'web.hook'

receivers:
  - name: 'web.hook'
    webhook_configs:
      - url: 'http://127.0.0.1:5001/'

  - name: 'email'
    email_configs:
      - to: 'dev-team@company.com'
        send_resolved: true

inhibit_rules:
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname']
```

## 监控面板配置

### 1. Grafana 仪表板

#### 1.1 概览面板
```json
{
  "dashboard": {
    "title": "Method Time Agent Overview",
    "panels": [
      {
        "title": "Agent Status",
        "type": "stat",
        "targets": [
          {
            "expr": "agent_cpu_usage",
            "legendFormat": "CPU Usage"
          },
          {
            "expr": "agent_memory_usage / 1024 / 1024",
            "legendFormat": "Memory Usage (MB)"
          }
        ]
      },
      {
        "title": "Data Collection",
        "type": "graph",
        "targets": [
          {
            "expr": "rate(method_calls_total[5m])",
            "legendFormat": "Call Rate"
          },
          {
            "expr": "data_loss_rate",
            "legendFormat": "Data Loss Rate"
          }
        ]
      }
    ]
  }
}
```

#### 1.2 性能分析面板
```json
{
  "dashboard": {
    "title": "Performance Analysis",
    "panels": [
      {
        "title": "Top Slow Methods",
        "type": "table",
        "targets": [
          {
            "expr": "topk(10, method_duration_avg)",
            "format": "table"
          }
        ]
      },
      {
        "title": "Method Duration Distribution",
        "type": "heatmap",
        "targets": [
          {
            "expr": "histogram_quantile(0.95, method_duration_bucket)",
            "legendFormat": "95th Percentile"
          }
        ]
      }
    ]
  }
}
```

#### 1.3 系统监控面板
```json
{
  "dashboard": {
    "title": "System Monitoring",
    "panels": [
      {
        "title": "Queue Usage",
        "type": "gauge",
        "targets": [
          {
            "expr": "queue_usage_rate * 100",
            "legendFormat": "Queue Usage %"
          }
        ]
      },
      {
        "title": "Database Status",
        "type": "stat",
        "targets": [
          {
            "expr": "db_connection_status",
            "legendFormat": "DB Connection"
          },
          {
            "expr": "db_record_count",
            "legendFormat": "Record Count"
          }
        ]
      }
    ]
  }
}
```

### 2. 自定义查询示例

#### 2.1 慢方法查询
```sql
-- 查询最近1小时的慢方法
SELECT 
    class_name,
    method_name,
    AVG(duration_ns) as avg_duration,
    COUNT(*) as call_count
FROM method_time_stat 
WHERE create_time > DATEADD('HOUR', -1, CURRENT_TIMESTAMP)
    AND duration_ns > 1000000  -- 超过1ms
GROUP BY class_name, method_name 
ORDER BY avg_duration DESC
LIMIT 20
```

#### 2.2 性能趋势查询
```sql
-- 按小时统计性能趋势
SELECT 
    DATE_FORMAT(create_time, '%Y-%m-%d %H:00:00') as hour,
    COUNT(*) as call_count,
    AVG(duration_ns) as avg_duration,
    MAX(duration_ns) as max_duration
FROM method_time_stat 
WHERE create_time > DATEADD('DAY', -1, CURRENT_TIMESTAMP)
GROUP BY DATE_FORMAT(create_time, '%Y-%m-%d %H:00:00')
ORDER BY hour
```

#### 2.3 异常统计查询
```sql
-- 查询异常统计
SELECT 
    'Collection Errors' as error_type,
    collection_errors_total as error_count
UNION ALL
SELECT 
    'Write Errors' as error_type,
    write_errors_total as error_count
UNION ALL
SELECT 
    'Failover Errors' as error_type,
    failover_errors_total as error_count
```

## 监控最佳实践

### 1. 指标收集策略
- **采样率调整**: 根据系统负载调整采样率
- **阈值设置**: 合理设置慢方法阈值
- **数据保留**: 根据存储容量设置数据保留策略

### 2. 告警配置建议
- **分级告警**: 设置不同严重级别的告警
- **抑制规则**: 避免告警风暴
- **通知渠道**: 配置多种通知方式

### 3. 性能优化
- **查询优化**: 使用索引优化查询性能
- **缓存策略**: 对热点数据进行缓存
- **批量处理**: 使用批量操作提高效率

### 4. 故障排查
- **日志分析**: 结合日志进行问题排查
- **指标关联**: 关联多个指标进行根因分析
- **历史对比**: 与历史数据进行对比分析

## 监控工具集成

### 1. ELK Stack 集成
```yaml
# logstash.conf
input {
  file {
    path => "/var/log/method_time_*.log"
    start_position => "beginning"
  }
}

filter {
  grok {
    match => { "message" => "\[%{TIMESTAMP_ISO8601:timestamp}\] \[%{WORD:level}\] %{GREEDYDATA:content}" }
  }
  
  if [content] =~ /CPU: / {
    grok {
      match => { "content" => "CPU: %{NUMBER:cpu_usage}%%, 内存: %{NUMBER:memory_usage} MB, 5s丢失: %{NUMBER:data_loss} 条" }
    }
  }
}

output {
  elasticsearch {
    hosts => ["localhost:9200"]
    index => "method-time-%{+YYYY.MM.dd}"
  }
}
```

### 2. 自定义监控脚本
```bash
#!/bin/bash
# monitor_script.sh

# 获取关键指标
get_metrics() {
    telnet localhost 5005 << EOF | grep -E "(CPU:|内存:|丢失:)"
agent status
quit
EOF
}

# 检查告警条件
check_alerts() {
    local cpu_usage=$(get_metrics | grep "CPU:" | awk '{print $2}' | sed 's/%//')
    local memory_usage=$(get_metrics | grep "内存:" | awk '{print $2}')
    local data_loss=$(get_metrics | grep "丢失:" | awk '{print $3}')
    
    # CPU 告警
    if (( $(echo "$cpu_usage > 80" | bc -l) )); then
        echo "WARNING: CPU usage is $cpu_usage%"
    fi
    
    # 内存告警
    if (( $(echo "$memory_usage > 1000" | bc -l) )); then
        echo "WARNING: Memory usage is $memory_usage MB"
    fi
    
    # 数据丢失告警
    if [ "$data_loss" -gt 0 ]; then
        echo "WARNING: Data loss detected: $data_loss records"
    fi
}

# 主循环
while true; do
    check_alerts
    sleep 60
done
``` 