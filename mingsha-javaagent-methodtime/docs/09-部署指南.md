# 部署指南

## 概述

本文档提供 mingsha-javaagent-methodtime 的完整部署指南，包括开发环境、测试环境和生产环境的部署方案。

## 环境要求

### 1. 系统要求
- **操作系统**: Linux/Unix/Windows
- **Java版本**: JDK 8+ (推荐 JDK 11+)
- **内存**: 最小 512MB，推荐 2GB+
- **磁盘**: 最小 1GB，推荐 10GB+
- **网络**: 支持 Telnet 协议

### 2. 依赖组件
- **Maven**: 3.6+ (用于构建)
- **Docker**: 20.10+ (可选，用于容器化部署)
- **监控系统**: Prometheus + Grafana (可选)

## 开发环境部署

### 1. 源码部署
```bash
# 1. 克隆项目
git clone <repository-url>
cd mingsha-javaagent-methodtime

# 2. 编译打包
mvn clean package

# 3. 配置应用
cp src/main/resources/agent-config.yml target/
# 编辑 target/agent-config.yml

# 4. 启动目标应用
java -javaagent:target/mingsha-javaagent-methodtime.jar -jar your-app.jar
```

### 2. 开发环境配置
```yaml
# agent-config.yml (开发环境)
collector:
  packages: "com.example.*"
  samplingRate: 1.0           # 全量采集
  minDurationNs: 10000        # 低阈值
  queueCapacity: 1000         # 小队列

storage:
  batchSize: 100              # 小批量
  retentionDays: 1            # 短期保留
  h2:
    path: "./dev_mingsha_javaagent_method_time_h2_db"

manage:
  telnet:
    port: 5005

monitor:
  cpu:
    fuseThreshold: 90         # 高阈值
  healthCheckIntervalMs: 10000

log:
  level: DEBUG                # 详细日志
```

## 测试环境部署

### 1. 测试环境配置
```yaml
# agent-config.yml (测试环境)
collector:
  packages: "com.test.*"
  samplingRate: 0.5           # 50%采样
  minDurationNs: 100000       # 100微秒阈值
  queueCapacity: 5000         # 中等队列

storage:
  batchSize: 500              # 中等批量
  retentionDays: 7            # 保留1周
  retentionRows: 1000000      # 100万条记录
  h2:
    path: "/data/test_mingsha_javaagent_method_time_h2_db"

manage:
  telnet:
    port: 5005
    maxThreads: 2

monitor:
  cpu:
    fuseThreshold: 80
  healthCheckIntervalMs: 5000

log:
  level: INFO
```

### 2. 自动化测试部署
```bash
#!/bin/bash
# deploy-test.sh

# 1. 停止现有应用
pkill -f "java.*your-app.jar"

# 2. 备份数据
cp -r /data/test_mingsha_javaagent_method_time_h2_db /data/backup/test_mingsha_javaagent_method_time_h2_db_$(date +%Y%m%d_%H%M%S)

# 3. 部署新版本
cp target/mingsha-javaagent-methodtime.jar /opt/apps/
cp target/agent-config.yml /opt/apps/

# 4. 启动应用
nohup java -javaagent:/opt/apps/mingsha-javaagent-methodtime.jar \
    -Xms1g -Xmx2g \
    -jar /opt/apps/your-app.jar > /var/log/app.log 2>&1 &

# 5. 验证部署
sleep 10
telnet localhost 5005 << EOF
agent status
quit
EOF
```

## 生产环境部署

### 1. 生产环境配置
```yaml
# agent-config.yml (生产环境)
collector:
  packages: "com.production.*"
  samplingRate: 0.1           # 10%采样，降低性能影响
  minDurationNs: 1000000      # 1ms阈值，只关注慢方法
  queueCapacity: 50000        # 大容量队列

storage:
  batchSize: 1000             # 大批量写入
  retentionDays: 30           # 保留30天
  retentionRows: 10000000     # 1000万条记录
  h2:
    path: "/data/prod_mingsha_javaagent_method_time_h2_db"

manage:
  telnet:
    port: 5005
    maxThreads: 1             # 限制并发

monitor:
  cpu:
    fuseThreshold: 70         # 严格的CPU限制
  healthCheckIntervalMs: 3000 # 频繁检查

log:
  level: WARN                 # 只记录警告和错误
```

### 2. 生产环境部署脚本
```bash
#!/bin/bash
# deploy-prod.sh

set -e

APP_NAME="your-app"
AGENT_JAR="/opt/apps/mingsha-javaagent-methodtime.jar"
APP_JAR="/opt/apps/${APP_NAME}.jar"
CONFIG_FILE="/opt/apps/agent-config.yml"
DATA_DIR="/data/prod_mingsha_javaagent_method_time_h2_db"
LOG_DIR="/var/log"
PID_FILE="/var/run/${APP_NAME}.pid"

# 1. 检查依赖
check_dependencies() {
    if [ ! -f "$AGENT_JAR" ]; then
        echo "错误: Agent JAR 文件不存在: $AGENT_JAR"
        exit 1
    fi
    
    if [ ! -f "$APP_JAR" ]; then
        echo "错误: 应用 JAR 文件不存在: $APP_JAR"
        exit 1
    fi
    
    if [ ! -f "$CONFIG_FILE" ]; then
        echo "错误: 配置文件不存在: $CONFIG_FILE"
        exit 1
    fi
}

# 2. 停止现有应用
stop_app() {
    if [ -f "$PID_FILE" ]; then
        PID=$(cat "$PID_FILE")
        if kill -0 "$PID" 2>/dev/null; then
            echo "停止应用 (PID: $PID)..."
            kill "$PID"
            sleep 5
            if kill -0 "$PID" 2>/dev/null; then
                echo "强制停止应用..."
                kill -9 "$PID"
            fi
        fi
        rm -f "$PID_FILE"
    fi
}

# 3. 备份数据
backup_data() {
    if [ -d "$DATA_DIR" ]; then
        BACKUP_DIR="/data/backup/prod_mingsha_javaagent_method_time_h2_db_$(date +%Y%m%d_%H%M%S)"
        echo "备份数据到: $BACKUP_DIR"
        cp -r "$DATA_DIR" "$BACKUP_DIR"
    fi
}

# 4. 启动应用
start_app() {
    echo "启动应用..."
    
    # 创建必要目录
    mkdir -p "$DATA_DIR" "$LOG_DIR"
    
    # 启动应用
    nohup java \
        -javaagent:"$AGENT_JAR" \
        -Xms2g -Xmx4g \
        -XX:+UseG1GC \
        -XX:MaxGCPauseMillis=200 \
        -Djava.security.egd=file:/dev/./urandom \
        -jar "$APP_JAR" \
        > "$LOG_DIR/${APP_NAME}.log" 2>&1 &
    
    # 保存PID
    echo $! > "$PID_FILE"
    echo "应用已启动 (PID: $(cat $PID_FILE))"
}

# 5. 验证部署
verify_deployment() {
    echo "验证部署..."
    sleep 10
    
    # 检查进程
    if [ ! -f "$PID_FILE" ] || ! kill -0 "$(cat $PID_FILE)" 2>/dev/null; then
        echo "错误: 应用启动失败"
        exit 1
    fi
    
    # 检查Agent状态
    if ! telnet localhost 5005 << EOF | grep -q "CPU:"
agent status
quit
EOF
    then
        echo "错误: Agent 未正常启动"
        exit 1
    fi
    
    echo "部署验证成功"
}

# 主流程
main() {
    echo "开始生产环境部署..."
    check_dependencies
    stop_app
    backup_data
    start_app
    verify_deployment
    echo "生产环境部署完成"
}

main "$@"
```

### 3. 系统服务配置
```ini
# /etc/systemd/system/your-app.service
[Unit]
Description=Your Application with Method Time Agent
After=network.target

[Service]
Type=simple
User=appuser
Group=appgroup
WorkingDirectory=/opt/apps
ExecStart=/usr/bin/java \
    -javaagent:/opt/apps/mingsha-javaagent-methodtime.jar \
    -Xms2g -Xmx4g \
    -XX:+UseG1GC \
    -XX:MaxGCPauseMillis=200 \
    -Djava.security.egd=file:/dev/./urandom \
    -jar /opt/apps/your-app.jar
Restart=always
RestartSec=10
PIDFile=/var/run/your-app.pid

[Install]
WantedBy=multi-user.target
```

## 容器化部署

### 1. Dockerfile
```dockerfile
# Dockerfile
FROM openjdk:11-jre-slim

# 安装必要工具
RUN apt-get update && apt-get install -y \
    telnet \
    netcat \
    && rm -rf /var/lib/apt/lists/*

# 创建应用用户
RUN groupadd -r appuser && useradd -r -g appuser appuser

# 创建目录
RUN mkdir -p /opt/apps /data /var/log
RUN chown -R appuser:appuser /opt/apps /data /var/log

# 复制文件
COPY target/mingsha-javaagent-methodtime.jar /opt/apps/
COPY target/agent-config.yml /opt/apps/
COPY target/your-app.jar /opt/apps/

# 切换到应用用户
USER appuser

# 暴露端口
EXPOSE 8080 5005

# 启动命令
CMD ["java", \
     "-javaagent:/opt/apps/mingsha-javaagent-methodtime.jar", \
     "-Xms1g", "-Xmx2g", \
     "-XX:+UseG1GC", \
     "-XX:MaxGCPauseMillis=200", \
     "-Djava.security.egd=file:/dev/./urandom", \
     "-jar", "/opt/apps/your-app.jar"]
```

### 2. Docker Compose
```yaml
# docker-compose.yml
version: '3.8'

services:
  app:
    build: .
    container_name: your-app
    ports:
      - "8080:8080"
      - "5005:5005"
    volumes:
      - method_time_data:/data
      - app_logs:/var/log
    environment:
      - JAVA_OPTS=-Xms1g -Xmx2g
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "telnet", "localhost", "5005"]
      interval: 30s
      timeout: 10s
      retries: 3

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=200h'
      - '--web.enable-lifecycle'
    restart: unless-stopped

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - "3000:3000"
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/dashboards:/etc/grafana/provisioning/dashboards
      - ./grafana/datasources:/etc/grafana/provisioning/datasources
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    restart: unless-stopped

volumes:
  method_time_data:
  app_logs:
  prometheus_data:
  grafana_data:
```

### 3. Kubernetes 部署
```yaml
# k8s-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: your-app
  labels:
    app: your-app
spec:
  replicas: 3
  selector:
    matchLabels:
      app: your-app
  template:
    metadata:
      labels:
        app: your-app
    spec:
      containers:
      - name: your-app
        image: your-app:latest
        ports:
        - containerPort: 8080
        - containerPort: 5005
        env:
        - name: JAVA_OPTS
          value: "-Xms1g -Xmx2g"
        resources:
          requests:
            memory: "2Gi"
            cpu: "500m"
          limits:
            memory: "4Gi"
            cpu: "1000m"
        volumeMounts:
        - name: method-time-data
          mountPath: /data
        - name: app-logs
          mountPath: /var/log
        livenessProbe:
          tcpSocket:
            port: 5005
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          tcpSocket:
            port: 5005
          initialDelaySeconds: 5
          periodSeconds: 5
      volumes:
      - name: method-time-data
        persistentVolumeClaim:
          claimName: method-time-pvc
      - name: app-logs
        emptyDir: {}

---
apiVersion: v1
kind: Service
metadata:
  name: your-app-service
spec:
  selector:
    app: your-app
  ports:
  - name: http
    port: 8080
    targetPort: 8080
  - name: telnet
    port: 5005
    targetPort: 5005
  type: ClusterIP

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: method-time-pvc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
```

## 监控集成

### 1. Prometheus 配置
```yaml
# prometheus.yml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

rule_files:
  - "method_time_rules.yml"

scrape_configs:
  - job_name: 'method-time-agent'
    static_configs:
      - targets: ['localhost:5005']
    metrics_path: '/metrics'
    scrape_interval: 30s
    scrape_timeout: 10s

  - job_name: 'your-app'
    static_configs:
      - targets: ['localhost:8080']
    metrics_path: '/actuator/prometheus'
    scrape_interval: 15s
```

### 2. Grafana 仪表板
```json
{
  "dashboard": {
    "title": "Method Time Agent Dashboard",
    "panels": [
      {
        "title": "Method Call Count",
        "type": "graph",
        "targets": [
          {
            "expr": "method_time_calls_total",
            "legendFormat": "{{class_name}}.{{method_name}}"
          }
        ]
      },
      {
        "title": "Average Method Duration",
        "type": "graph",
        "targets": [
          {
            "expr": "method_time_duration_avg",
            "legendFormat": "{{class_name}}.{{method_name}}"
          }
        ]
      }
    ]
  }
}
```

## 性能调优

### 1. JVM 调优
```bash
# 生产环境 JVM 参数
java \
  -javaagent:/opt/apps/mingsha-javaagent-methodtime.jar \
  -Xms4g -Xmx4g \
  -XX:+UseG1GC \
  -XX:MaxGCPauseMillis=200 \
  -XX:G1HeapRegionSize=16m \
  -XX:+UnlockExperimentalVMOptions \
  -XX:+UseStringDeduplication \
  -XX:+UseCompressedOops \
  -XX:+UseCompressedClassPointers \
  -Djava.security.egd=file:/dev/./urandom \
  -jar your-app.jar
```

### 2. 系统调优
```bash
# /etc/sysctl.conf
# 文件描述符限制
fs.file-max = 65536

# 网络参数
net.core.somaxconn = 65535
net.ipv4.tcp_max_syn_backlog = 65535

# 内存参数
vm.swappiness = 10
vm.dirty_ratio = 15
vm.dirty_background_ratio = 5
```

### 3. 应用调优
```yaml
# agent-config.yml (优化配置)
collector:
  samplingRate: 0.05          # 5%采样，进一步降低影响
  minDurationNs: 5000000      # 5ms阈值，只关注慢方法
  queueCapacity: 100000       # 大容量队列

storage:
  batchSize: 2000             # 大批量写入
  retentionDays: 7            # 短期保留，减少存储压力

monitor:
  cpu:
    fuseThreshold: 60         # 更严格的CPU限制
  healthCheckIntervalMs: 10000 # 降低检查频率
```

## 安全配置

### 1. 网络安全
```bash
# 防火墙配置
iptables -A INPUT -p tcp --dport 5005 -s 192.168.1.0/24 -j ACCEPT
iptables -A INPUT -p tcp --dport 5005 -j DROP
```

### 2. 文件权限
```bash
# 设置文件权限
chown -R appuser:appgroup /opt/apps
chmod 755 /opt/apps
chmod 644 /opt/apps/*.jar
chmod 600 /opt/apps/agent-config.yml
```

### 3. 监控安全
```yaml
# 监控访问控制
manage:
  telnet:
    port: 5005
    maxThreads: 1
    allowedHosts: ["192.168.1.0/24"]  # 限制访问IP
```

## 故障恢复

### 1. 数据恢复
```bash
#!/bin/bash
# recover-data.sh

# 从备份恢复数据
BACKUP_DIR="/data/backup/prod_mingsha_javaagent_method_time_h2_db_20231201_120000"
DATA_DIR="/data/prod_mingsha_javaagent_method_time_h2_db"

if [ -d "$BACKUP_DIR" ]; then
    echo "从备份恢复数据: $BACKUP_DIR"
    rm -rf "$DATA_DIR"
    cp -r "$BACKUP_DIR" "$DATA_DIR"
    chown -R appuser:appgroup "$DATA_DIR"
    echo "数据恢复完成"
else
    echo "错误: 备份目录不存在: $BACKUP_DIR"
    exit 1
fi
```

### 2. 服务恢复
```bash
#!/bin/bash
# restart-service.sh

# 重启服务
systemctl restart your-app

# 验证服务状态
sleep 10
if systemctl is-active --quiet your-app; then
    echo "服务重启成功"
    telnet localhost 5005 << EOF
agent status
quit
EOF
else
    echo "服务重启失败"
    systemctl status your-app
    exit 1
fi
``` 