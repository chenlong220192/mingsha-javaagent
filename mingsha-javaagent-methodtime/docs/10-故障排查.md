# 故障排查指南

## 概述

本文档提供 mingsha-javaagent-methodtime 的故障排查指南，包括常见错误、诊断方法和解决方案。

## 字节码增强相关问题

### 1. VerifyError: Bad type on operand stack

**错误现象**：
```
java.lang.VerifyError: Bad type on operand stack
Exception Details:
  Location: com/example/MyClass.<init>()V @22: iflt
  Reason: Type long_2nd (current frame, stack[3]) is not assignable to integer
```

**原因分析**：
- 字节码增强时栈操作类型不匹配
- 包名错误导致类引用失败
- 采样率逻辑的字节码生成错误

**解决方案**：
1. **使用最新版本**：确保使用修复后的 Agent 版本
2. **检查包名**：Agent 内部包名已修复为 `site.mingsha.javaagent.methodtime.*`
3. **禁用采样率**：临时禁用采样率进行测试
   ```bash
   -Dmingsha.agent.config.collector.samplingRate=1.0
   ```

### 2. VerifyError: Expecting a stackmap frame at branch target

**错误现象**：
```
java.lang.VerifyError: Expecting a stackmap frame at branch target 53
Exception Details:
  Location: com/example/MyClass.<init>()V @23: iflt
  Reason: Expected stackmap frame at this location.
```

**原因分析**：
- 字节码增强时栈帧映射计算错误
- 使用 `ClassWriter.COMPUTE_MAXS` 无法正确处理栈帧
- 跳转指令的栈帧状态不一致

**解决方案**：
1. **使用最新版本**：已修复为使用 `ClassWriter.COMPUTE_FRAMES`
2. **检查 Java 版本**：确保目标应用使用 Java 8+ 版本
3. **简化配置**：使用默认配置进行测试

### 3. 字节码增强兼容性问题

**常见问题**：
- 目标应用使用较新的 Java 版本（如 Java 17+）
- 目标应用使用了模块化系统（JPMS）
- 目标应用使用了特殊的字节码优化

**解决方案**：
1. **升级 ASM 版本**：Agent 使用 ASM 9.5，支持 Java 8-21
2. **检查模块权限**：确保 Agent 有足够的模块访问权限
3. **使用兼容模式**：某些情况下可能需要调整字节码增强策略

## 配置相关问题

### 1. Agent 启动正常但没有数据采集

**诊断步骤**：
1. **检查包范围配置**：
   ```bash
   # 连接 Telnet 查看配置
   telnet localhost 5005
   agent config
   ```

2. **检查采样率设置**：
   - 开发环境建议使用 `samplingRate: 1.0`
   - 生产环境可根据需要调整

3. **检查最小耗时阈值**：
   - 默认值：100000 ns (0.1ms)
   - 如果设置过高，可能过滤掉所有数据

**解决方案**：
```bash
# 使用更宽松的配置进行测试
java -javaagent:target/mingsha-javaagent-methodtime-0.0.1-SNAPSHOT.jar \
     -Dmingsha.agent.config.collector.packages="com.* "\
     -Dmingsha.agent.config.collector.samplingRate=1.0 \
     -Dmingsha.agent.config.collector.minDurationNs=1000 \
     -jar your-app.jar
```

### 2. 配置覆盖不生效

**诊断步骤**：
1. **检查系统属性格式**：
   - 正确格式：`-Dmingsha.agent.config.xxx=value`
   - 注意大小写和层级结构

2. **检查启动日志**：
   - Agent 启动时会打印当前使用的配置
   - 确认配置是否被正确读取

**解决方案**：
```bash
# 正确的配置覆盖示例
java -javaagent:target/mingsha-javaagent-methodtime-0.0.1-SNAPSHOT.jar \
     -Dmingsha.agent.config.collector.packages="com.myapp.* "\
     -Dmingsha.agent.config.collector.samplingRate=0.5 \
     -Dmingsha.agent.config.storage.h2.path="./my_db" \
     -Dmingsha.agent.config.manage.telnet.port=5006 \
     -jar your-app.jar
```

## 数据库相关问题

### 1. 数据库连接失败

**错误现象**：
```
[mingsha-agent][数据库] 数据库连接失败
```

**原因分析**：
- 数据库路径配置错误
- 文件权限问题
- 磁盘空间不足

**解决方案**：
1. **检查路径配置**：
   ```bash
   # 使用绝对路径
   -Dmingsha.agent.config.storage.h2.path="/tmp/my_db"
   
   # 使用内存模式
   -Dmingsha.agent.config.storage.h2.path="mem:mingsha_test"
   ```

2. **检查文件权限**：
   ```bash
   # 确保目录可写
   chmod 755 /path/to/db/directory
   ```

3. **检查磁盘空间**：
   ```bash
   df -h
   ```

### 2. 数据库表不存在

**诊断步骤**：
```bash
# 连接 Telnet 检查表结构
telnet localhost 5005
db tables
db schema
```

**解决方案**：
1. **重启 Agent**：首次启动时会自动建表
2. **手动建表**：如果自动建表失败，可以手动执行建表 SQL
3. **检查数据库版本**：确保使用兼容的 H2 数据库版本

## Telnet 管理相关问题

### 1. Telnet 连接失败

**错误现象**：
```
telnet: connect to address 127.0.0.1: Connection refused
```

**原因分析**：
- Telnet 端口被占用
- Agent 未正常启动
- 防火墙阻止连接

**解决方案**：
1. **检查端口占用**：
   ```bash
   netstat -an | grep 5005
   lsof -i :5005
   ```

2. **检查 Agent 状态**：
   - 查看启动日志确认 Telnet 端口
   - 默认端口：5005，冲突时自动切换

3. **使用指定端口**：
   ```bash
   -Dmingsha.agent.config.manage.telnet.port=5006
   ```

### 2. Telnet 命令执行失败

**常见问题**：
- SQL 语法错误
- 权限不足
- 数据库连接问题

**解决方案**：
1. **检查 SQL 语法**：使用简单的查询进行测试
2. **查看错误信息**：Telnet 会返回详细的错误信息
3. **重启 Agent**：如果数据库连接异常，重启 Agent

## 性能相关问题

### 1. CPU 使用率过高

**诊断步骤**：
```bash
# 连接 Telnet 查看状态
telnet localhost 5005
agent status
```

**解决方案**：
1. **调整采样率**：降低采样率减少 CPU 使用
2. **调整包范围**：缩小采集包范围
3. **调整批量大小**：增加批量写入大小
4. **启用 CPU 熔断**：设置合理的熔断阈值

### 2. 内存使用过高

**诊断步骤**：
```bash
# 查看内存使用
agent status
```

**解决方案**：
1. **调整队列容量**：减少缓冲队列大小
2. **启用自动清理**：定期清理历史数据
3. **使用内存模式**：开发环境使用内存模式
4. **调整批量大小**：减少批量写入大小

## 日志分析

### 1. 启动日志分析

**正常启动日志**：
```
[mingsha-agent] premain start
[mingsha-agent] Current Configuration:
  Collector Packages: com.example.*
  Sampling Rate: 1.0
  Min Duration (ns): 100000
  Queue Capacity: 10000
  Batch Size: 500
  Slow Query Threshold (ns): 1000000
  H2 Path: mem:mingsha_javaagent_method_time_h2_db
  Telnet Port: 5005
  CPU Fuse Threshold: 80%
  Log Level: INFO
[mingsha-agent][数据库] 数据库初始化完成，已创建主表、汇总表、慢查询表
[mingsha-agent] Telnet 管理端口: 5005
```

**异常启动日志**：
- 配置错误：检查配置项格式和值
- 数据库错误：检查数据库路径和权限
- 端口冲突：检查端口占用情况

### 2. 运行时日志分析

**正常运行时日志**：
```
[mingsha-agent][清理] 内存模式历史数据清理完成，已清理主表和慢查询表，重新计算汇总表
```

**异常运行时日志**：
- 数据丢失：检查队列容量和批量大小
- 数据库错误：检查数据库连接和磁盘空间
- 线程异常：检查线程健康状态

## 调试技巧

### 1. 启用调试日志

```bash
-Dmingsha.agent.config.log.level=DEBUG
```

### 2. 使用简单配置测试

```bash
# 最小化配置进行测试
java -javaagent:target/mingsha-javaagent-methodtime-0.0.1-SNAPSHOT.jar \
     -Dmingsha.agent.config.collector.packages="com.example.* "\
     -Dmingsha.agent.config.collector.samplingRate=1.0 \
     -Dmingsha.agent.config.storage.h2.path="mem:test" \
     -jar your-app.jar
```

### 3. 分步骤验证

1. **验证 Agent 启动**：检查启动日志
2. **验证配置加载**：检查配置打印信息
3. **验证数据库初始化**：检查数据库初始化日志
4. **验证 Telnet 连接**：连接 Telnet 管理端口
5. **验证数据采集**：执行测试方法，查看数据

## 联系支持

如果遇到本文档未覆盖的问题，请：

1. **收集信息**：
   - 错误日志
   - 配置信息
   - 环境信息（Java 版本、操作系统等）

2. **提供复现步骤**：
   - 详细的复现步骤
   - 最小化测试用例

3. **提交 Issue**：
   - 在项目仓库提交 Issue
   - 包含完整的错误信息和环境信息 