# 快速开始

## 概述

mingsha-javaagent-methodtime 是一个高性能的 Java 方法耗时采集工具，基于 ASM 字节码增强技术，能够无侵入地监控 Java 应用的性能。本文档将帮助你在 5 分钟内快速上手使用。

## 环境要求

### 基础环境
- **Java**: JDK 8+ (推荐 JDK 11+)
- **Maven**: 3.6+ (用于构建)
- **操作系统**: Linux/Unix/Windows

### 目标应用
- 任何 Java 应用（Spring Boot、Tomcat、Jetty 等）
- 支持 JVM 参数配置

## 快速安装

### 1. 获取项目
```bash
# 克隆项目
git clone <repository-url>
cd mingsha-javaagent-methodtime

# 编译打包
mvn clean package
```

### 2. 准备配置文件
```bash
# 复制配置文件
cp src/main/resources/agent-config.yml target/
```

### 3. 编辑配置
```yaml
# target/agent-config.yml
collector:
  packages: "com.example.*"   # 采集指定包
  samplingRate: 1.0           # 全量采集
  minDurationNs: 100000       # 最小耗时100微秒
  queueCapacity: 10000        # 队列容量

storage:
  batchSize: 500              # 批量写入
  h2:
    path: "./mingsha_javaagent_method_time_h2_db"  # 数据库路径

manage:
  telnet:
    port: 5005                # 管理端口

monitor:
  cpu:
    fuseThreshold: 80         # CPU熔断阈值
```

## 快速使用

### 1. 启动目标应用（默认配置）
```bash
# 使用 javaagent 启动应用
java -javaagent:target/mingsha-javaagent-methodtime-0.0.1-SNAPSHOT.jar -jar your-app.jar

# 或者启动 Spring Boot 应用
java -javaagent:target/mingsha-javaagent-methodtime-0.0.1-SNAPSHOT.jar \
     -jar target/your-spring-boot-app.jar
```

> **重要提示**：Agent 使用 ASM 9.5 进行字节码增强，支持 Java 8+ 版本。如果遇到字节码验证错误，请确保目标应用与 Agent 的 Java 版本兼容。

### 2. 启动目标应用（自定义配置）

#### 文件模式（生产环境推荐）
```bash
# 通过JVM系统属性覆盖配置
java -javaagent:target/mingsha-javaagent-methodtime-0.0.1-SNAPSHOT.jar \
     -Dmingsha.agent.config.collector.packages="com.myapp.* "\
     -Dmingsha.agent.config.collector.samplingRate=0.5 \
     -Dmingsha.agent.config.storage.h2.path="./my_app_db" \
     -Dmingsha.agent.config.manage.telnet.port=5006 \
     -jar your-app.jar
```

#### 内存模式（开发测试推荐）
```bash
# 内存模式，数据不持久化
java -javaagent:target/mingsha-javaagent-methodtime-0.0.1-SNAPSHOT.jar \
     -Dmingsha.agent.config.collector.packages="com.myapp.* "\
     -Dmingsha.agent.config.collector.samplingRate=0.5 \
     -Dmingsha.agent.config.storage.h2.path="mem:mingsha_test" \
     -Dmingsha.agent.config.manage.telnet.port=5006 \
     -jar your-app.jar
```

### 3. 配置覆盖说明
Agent支持通过JVM系统属性覆盖所有配置项，无需修改jar包内容：

| 配置项 | 系统属性名 | 示例值 | 说明 |
|--------|------------|--------|------|
| 采集包范围 | `mingsha.agent.config.collector.packages` | `com.myapp.*` | 支持通配符 |
| 采样率 | `mingsha.agent.config.collector.samplingRate` | `0.5` | 0~1之间 |
| 最小耗时阈值 | `mingsha.agent.config.collector.minDurationNs` | `1000000` | 纳秒 |
| 缓冲队列容量 | `mingsha.agent.config.collector.queueCapacity` | `20000` | 条数 |
| 批量写入条数 | `mingsha.agent.config.storage.batchSize` | `1000` | 条数 |
| 慢查询阈值 | `mingsha.agent.config.storage.slowQueryThresholdNs` | `500000` | 纳秒（0.5ms） |
| H2数据库路径 | `mingsha.agent.config.storage.h2.path` | `./my_db` 或 `mem:mingsha` | 文件路径或内存模式 |
| Telnet端口 | `mingsha.agent.config.manage.telnet.port` | `5006` | 端口号 |
| CPU熔断阈值 | `mingsha.agent.config.monitor.cpu.fuseThreshold` | `90` | 百分比 |
| 日志级别 | `mingsha.agent.config.log.level` | `DEBUG` | 日志级别 |

> **注意**：系统属性优先级高于YAML配置文件，启动时会自动打印当前使用的配置信息。

### 4. 验证安装
```bash
# 连接管理端口（注意端口可能被覆盖）
telnet localhost 5005

# 查看状态
agent status
```

你应该看到类似输出：
```
欢迎使用 mingsha-agent 管理端口，输入 help 查看命令
CPU: 15.23%, 内存: 256 MB, 总丢失: 0 条
```

启动时还会显示当前配置信息和数据库初始化信息：
```
[mingsha-agent] Current Configuration:
  Collector Packages: com.myapp.*
  Sampling Rate: 0.5
  Min Duration (ns): 1000000
  Queue Capacity: 20000
  Batch Size: 1000
  Slow Query Threshold (ns): 1000000
  H2 Path: ./my_app_db
  Telnet Port: 5006
  CPU Fuse Threshold: 90%
  Log Level: DEBUG

[mingsha-agent][数据库] 数据库初始化完成，已创建主表、汇总表、慢查询表
[mingsha-agent][数据库] Database initialization completed, created main table, summary table, slow query table
```

### 5. 自动建库建表功能

Agent启动时会自动完成以下数据库初始化工作：

### 6. 故障排查

#### 常见问题

**Q: 启动时遇到 `java.lang.VerifyError: Bad type on operand stack` 错误？**

A: 这是字节码验证错误，通常由以下原因引起：
1. **包名错误**：Agent 内部包名已修复为 `site.mingsha.javaagent.methodtime.*`
2. **栈帧映射问题**：已使用 `ClassWriter.COMPUTE_FRAMES` 自动计算栈帧
3. **采样率逻辑错误**：已修复采样率检查的字节码逻辑

**解决方案**：
- 确保使用最新版本的 Agent
- 检查目标应用的 Java 版本兼容性（推荐 Java 8+）
- 如果问题持续，可以尝试禁用采样率：`-Dmingsha.agent.config.collector.samplingRate=1.0`

**Q: 启动时遇到 `java.lang.VerifyError: Expecting a stackmap frame at branch target` 错误？**

A: 这是栈帧映射问题，已通过以下方式修复：
1. 使用 `ClassWriter.COMPUTE_FRAMES` 自动计算栈帧
2. 优化字节码增强逻辑，确保栈操作正确
3. 修复采样率和最小耗时过滤的跳转逻辑

**Q: Agent 启动正常但没有数据采集？**

A: 可能的原因和解决方案：
1. **包范围配置错误**：检查 `collector.packages` 配置是否匹配目标类
2. **采样率过低**：检查 `samplingRate` 配置，建议开发环境使用 1.0
3. **最小耗时阈值过高**：检查 `minDurationNs` 配置，建议从 100000 开始

**验证方法**：
```bash
# 连接 Telnet 查看状态
telnet localhost 5005
agent status

# 查看配置信息
agent config
```

#### 自动创建的表
1. **method_time_stat** - 主表：存储所有方法耗时记录
   - 包含：类名、方法名、开始时间、结束时间、耗时、线程名、额外信息、创建时间
   - 索引：类名+方法名、耗时、创建时间、线程名

2. **method_time_stat_summary** - 汇总表：按方法统计调用次数、平均耗时等
   - 包含：类名、方法名、总调用次数、总耗时、平均耗时、最小耗时、最大耗时、最后更新时间
   - 索引：平均耗时、总调用次数
   - 唯一约束：类名+方法名

3. **method_time_stat_slow** - 慢查询表：存储超过阈值的慢查询记录
   - 包含：类名、方法名、耗时、线程名、额外信息、创建时间
   - 索引：耗时、创建时间

4. **db_version** - 版本表：记录数据库版本信息
   - 包含：版本号、描述、创建时间

#### 自动功能
- **自动建库建表**：首次启动时自动创建数据库文件和所有表结构
- **自动汇总统计**：每次数据写入时自动更新汇总表统计信息
- **自动慢查询识别**：自动识别并记录超过阈值的慢查询
- **自动索引优化**：为常用查询字段创建索引，提升查询性能
- **自动数据清理**：定期清理过期数据，重新计算汇总统计

#### 验证自动建库建表
```bash
# 查看所有表
db tables

# 查看表结构
db schema

# 查看数据库统计
db stats
```

输出示例：
```
=== 数据库表列表 ===
表名: METHOD_TIME_STAT (类型: TABLE)
表名: METHOD_TIME_STAT_SUMMARY (类型: TABLE)
表名: METHOD_TIME_STAT_SLOW (类型: TABLE)
表名: DB_VERSION (类型: TABLE)

=== 数据库统计信息 ===
【主表统计】
总记录数: 1250
今日记录数: 1250
平均耗时: 1250000.00 ns (1.25 ms)
最大耗时: 5000000 ns (5 ms)

【汇总表统计】
汇总方法数: 15
总调用次数: 1250
调用次数最多的方法 (Top 5):
  com.example.TestService.testMethod - 500 次
  com.example.UserService.getUser - 300 次

【慢查询统计】
慢查询记录数: 25
今日慢查询数: 25
最慢查询 (Top 5):
  com.example.TestService.slowMethod - 5000000 ns (5 ms)
```

### 5. 基本操作

#### 查看帮助
```bash
help
```

#### 查看状态
```bash
agent status
```

#### 执行查询
```bash
# 查询总记录数
SELECT COUNT(*) FROM method_time_stat

# 查询汇总统计
SELECT * FROM method_time_stat_summary ORDER BY total_calls DESC LIMIT 10

# 查询慢查询记录
SELECT * FROM method_time_stat_slow ORDER BY duration_ns DESC LIMIT 10

# 查询最近1小时的数据
SELECT COUNT(*) FROM method_time_stat 
WHERE create_time > DATEADD('HOUR', -1, CURRENT_TIMESTAMP)

# 查询平均耗时最长的方法
SELECT class_name, method_name, avg_duration_ns 
FROM method_time_stat_summary 
ORDER BY avg_duration_ns DESC LIMIT 10
```

#### 导出数据
```bash
agent export /tmp/method_time_data.csv
```

## 配置说明

### 配置方式

Agent支持两种配置方式：

1. **YAML配置文件**：修改 `agent-config.yml` 文件
2. **JVM系统属性**：通过 `-D` 参数覆盖（推荐）

### 完整配置示例

#### YAML配置文件（agent-config.yml）
```yaml
collector:
  packages: "com.example.*"   # 采集包范围，支持通配符
  samplingRate: 1.0           # 采样率，1.0为全量
  minDurationNs: 100000       # 最小采集耗时（纳秒）
  queueCapacity: 10000        # 内存缓冲队列容量

storage:
  batchSize: 500              # 批量写入条数
  failoverThreshold: 2000     # 写入失败转存阈值
  retentionDays: 7            # 数据留存天数
  retentionRows: 1000000      # 数据留存最大条数
  slowQueryThresholdNs: 1000000  # 慢查询阈值（纳秒），默认1ms
  h2:
    path: "./mingsha_javaagent_method_time_h2_db"  # H2 数据库文件路径

manage:
  telnet:
    port: 5005                # Telnet 管理端口
    maxThreads: 1             # Telnet 最大线程数

monitor:
  cpu:
    fuseThreshold: 80         # CPU 熔断阈值（%）
  healthCheckIntervalMs: 5000 # 健康检查间隔（ms）

log:
  level: INFO                 # 日志级别
```

#### JVM系统属性覆盖
```bash
# 覆盖所有配置项
java -javaagent:target/mingsha-javaagent-methodtime-0.0.1-SNAPSHOT.jar \
     -Dmingsha.agent.config.collector.packages="com.myapp.* "\
     -Dmingsha.agent.config.collector.samplingRate=0.5 \
     -Dmingsha.agent.config.collector.minDurationNs=1000000 \
     -Dmingsha.agent.config.collector.queueCapacity=20000 \
     -Dmingsha.agent.config.storage.batchSize=1000 \
     -Dmingsha.agent.config.storage.failoverThreshold=5000 \
     -Dmingsha.agent.config.storage.retentionDays=30 \
     -Dmingsha.agent.config.storage.retentionRows=2000000 \
     -Dmingsha.agent.config.storage.slowQueryThresholdNs=500000 \
     -Dmingsha.agent.config.storage.h2.path="./my_app_db" \
     -Dmingsha.agent.config.manage.telnet.port=5006 \
     -Dmingsha.agent.config.manage.telnet.maxThreads=2 \
     -Dmingsha.agent.config.monitor.cpu.fuseThreshold=90 \
     -Dmingsha.agent.config.monitor.healthCheckIntervalMs=10000 \
     -Dmingsha.agent.config.log.level=DEBUG \
     -jar your-app.jar
```

### 配置项说明

#### collector 采集配置
- **packages**: 指定要采集的包范围，支持通配符
  - YAML: `collector.packages`
  - 系统属性: `mingsha.agent.config.collector.packages`
- **samplingRate**: 采样率，0.0-1.0，1.0表示全量采集
  - YAML: `collector.samplingRate`
  - 系统属性: `mingsha.agent.config.collector.samplingRate`
- **minDurationNs**: 最小采集耗时，低于此值的方法不采集
  - YAML: `collector.minDurationNs`
  - 系统属性: `mingsha.agent.config.collector.minDurationNs`
- **queueCapacity**: 内存缓冲队列容量，影响内存使用
  - YAML: `collector.queueCapacity`
  - 系统属性: `mingsha.agent.config.collector.queueCapacity`

#### storage 存储配置
- **batchSize**: 批量写入条数，影响写入性能
  - YAML: `storage.batchSize`
  - 系统属性: `mingsha.agent.config.storage.batchSize`
- **failoverThreshold**: 写入失败转存阈值
  - YAML: `storage.failoverThreshold`
  - 系统属性: `mingsha.agent.config.storage.failoverThreshold`
- **retentionDays**: 数据保留天数，自动清理过期数据
  - YAML: `storage.retentionDays`
  - 系统属性: `mingsha.agent.config.storage.retentionDays`
- **retentionRows**: 数据保留最大条数
  - YAML: `storage.retentionRows`
  - 系统属性: `mingsha.agent.config.storage.retentionRows`
- **slowQueryThresholdNs**: 慢查询阈值（纳秒），超过此值的方法会被记录到慢查询表
  - YAML: `storage.slowQueryThresholdNs`
  - 系统属性: `mingsha.agent.config.storage.slowQueryThresholdNs`
  - 默认值: 1000000（1毫秒）
- **h2.path**: H2数据库路径（**必须配置，无默认值！**）
  - YAML: `storage.h2.path`
  - 系统属性: `mingsha.agent.config.storage.h2.path`
  - **内存模式**: `mem:数据库名` (如: `mem:mingsha`)，数据存储在内存中，进程退出即丢失
  - **文件模式**: 普通路径 (如: `./mingsha_db`)，数据存储在磁盘文件中，持久化保存

> ⚠️ **注意：H2数据库路径必须配置，未配置将启动失败。建议通过JVM参数或配置文件显式指定。**
> 
> **模式选择建议：**
> - **开发/测试**: 使用内存模式 `mem:xxx`，无需清理文件，重启即空
> - **生产环境**: 使用文件模式，保证数据持久化，避免进程重启丢失数据

#### manage 管理配置
- **telnet.port**: Telnet管理端口
  - YAML: `manage.telnet.port`
  - 系统属性: `mingsha.agent.config.manage.telnet.port`
- **telnet.maxThreads**: Telnet最大线程数
  - YAML: `manage.telnet.maxThreads`
  - 系统属性: `mingsha.agent.config.manage.telnet.maxThreads`

#### monitor 监控配置
- **cpu.fuseThreshold**: CPU熔断阈值，超过此值暂停采集
  - YAML: `monitor.cpu.fuseThreshold`
  - 系统属性: `mingsha.agent.config.monitor.cpu.fuseThreshold`
- **healthCheckIntervalMs**: 健康检查间隔
  - YAML: `monitor.healthCheckIntervalMs`
  - 系统属性: `mingsha.agent.config.monitor.healthCheckIntervalMs`

#### log 日志配置
- **level**: 日志级别（INFO/DEBUG/ERROR）
  - YAML: `log.level`
  - 系统属性: `mingsha.agent.config.log.level`

## Telnet 管理命令

### 基础命令
- `help`                查看所有支持命令
- `agent help`          查看Agent管理命令
- `db help`             查看数据库查询命令

### Agent管理命令
- `agent status`        查看监控信息（CPU、内存、丢失率等）
- `agent config`        查看当前所有配置项
- `agent info`          查看Agent详细信息（版本、内存、系统信息等）
- `agent version`       查看版本信息
- `agent errors`        查看采集/写入/转存异常统计
- `agent reload`        动态热加载配置
- `agent export <file>` 导出全部采集数据为 CSV 文件

### 数据库查询命令
- `db info`             查看数据库连接信息
- `db tables`           查看所有表列表
- `db schema`           查看所有表结构
- `db stats`            查看数据库统计信息（主表、汇总表、慢查询表统计）
- `db size`             查看数据库文件大小
- `db query <sql>`      执行自定义SQL查询
- `select ...`          直接执行SELECT查询（SQL 沙箱，禁止高危操作）

#### 数据库表说明
- **method_time_stat** - 主表：存储所有方法耗时记录
- **method_time_stat_summary** - 汇总表：按方法统计调用次数、平均耗时等
- **method_time_stat_slow** - 慢查询表：存储超过阈值的慢查询记录
- **db_version** - 版本表：记录数据库版本信息

> **安全说明**：SQL 沙箱禁止 update、delete、insert、drop、alter、create、union、with、子查询、多语句等高危操作。

### 命令使用示例

#### 查看帮助信息
```bash
help
```
输出示例：
```
=== mingsha-agent 管理命令 ===
基础命令:
  help                    - 显示此帮助信息
  agent help              - 显示Agent管理命令
  db help                 - 显示数据库查询命令

Agent管理:
  agent status            - 查看Agent状态
  agent config            - 查看当前配置
  agent info              - 查看Agent详细信息
  agent version           - 查看版本信息
  agent errors            - 查看异常统计
  agent reload            - 热加载配置
  agent export <file>     - 导出数据到CSV

数据库查询:
  db info                 - 查看数据库信息
  db tables               - 查看所有表
  db schema               - 查看表结构
  db stats                - 查看数据库统计
  db size                 - 查看数据库大小
  db query <sql>          - 执行SQL查询
  select ...              - 直接执行SELECT查询
```

#### 查看系统状态
```bash
agent status
```
输出示例：
```
CPU: 15.23%, 内存: 256 MB, 总丢失: 0 条
```

#### 查看Agent配置
```bash
agent config
```
输出示例：
```
=== Agent配置信息 ===
采集配置:
  采集包范围: com.example.*
  采样率: 1.0
  最小耗时阈值: 100000 ns
  缓冲队列容量: 10000

存储配置:
  批量写入条数: 500
  转存阈值: 2000
  数据留存天数: 7
  数据留存条数: 1000000
  H2数据库路径: ./method_time_db

管理配置:
  Telnet端口: 5005
  Telnet最大线程数: 1

监控配置:
  CPU熔断阈值: 80%
  健康检查间隔: 5000 ms

日志配置:
  日志级别: INFO
```

#### 查看Agent详细信息
```bash
agent info
```
输出示例：
```
=== Agent详细信息 ===
版本: mingsha-javaagent-methodtime v0.0.1-SNAPSHOT
作者: mingsha
技术栈: ASM + H2 + Telnet
启动时间: Sat Jul 12 02:20:55 CST 2025
JVM版本: 17.0.2
操作系统: Mac OS X 14.5.0
内存信息:
  总内存: 512 MB
  已用内存: 128 MB
  空闲内存: 384 MB
  最大内存: 8192 MB
```

#### 查看数据库信息
```bash
db info
```
输出示例：
```
=== 数据库信息 ===
数据库产品: H2
数据库版本: 2.2.224 (2024-01-15)
驱动名称: H2 JDBC Driver
驱动版本: 2.2.224 (2024-01-15)
连接URL: jdbc:h2:file:./method_time_db;AUTO_SERVER=TRUE
用户名: sa
数据库路径: ./method_time_db
```

#### 查看数据库统计
```bash
db stats
```
输出示例：
```
=== 数据库统计信息 ===
总记录数: 1234
今日记录数: 567
平均耗时: 125000.50 ns (0.13 ms)
最大耗时: 5000000 ns (5 ms)
最小耗时: 10000 ns (0.01 ms)

调用次数最多的方法 (Top 5):
  com.example.Service.processData - 234 次
  com.example.Controller.handleRequest - 123 次
  com.example.Dao.queryData - 89 次

平均耗时最长的方法 (Top 5):
  com.example.Service.processData - 250000.00 ns
  com.example.Dao.queryData - 180000.00 ns
  com.example.Controller.handleRequest - 120000.00 ns
```

#### 查看表结构
```bash
db schema
```
输出示例：
```
=== method_time_stat 表结构 ===
字段名		数据类型		是否为空		默认值		说明
------		--------		--------		--------		----
ID		BIGINT		NO		NULL		
CLASS_NAME		VARCHAR		YES		NULL		
METHOD_NAME		VARCHAR		YES		NULL		
START_TIME		BIGINT		YES		NULL		
END_TIME		BIGINT		YES		NULL		
DURATION_NS		BIGINT		YES		NULL		
THREAD_NAME		VARCHAR		YES		NULL		
EXTRA_INFO		VARCHAR		YES		NULL		
CREATE_TIME		TIMESTAMP		YES		CURRENT_TIMESTAMP		
```

#### 查看异常统计
```bash
agent errors
```
输出示例：
```
采集异常: 0 次
写入异常: 0 次
转存异常: 0 次
```

#### 导出数据
```bash
agent export /tmp/method_time_data.csv
```
输出示例：
```
导出完成: /tmp/method_time_data.csv (1234 条记录)
```

#### 热加载配置
```bash
agent reload
```
输出示例：
```
配置重新加载成功
```

## 采集数据表结构（H2）

### 数据表定义
```sql
CREATE TABLE IF NOT EXISTS method_time_stat (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    class_name VARCHAR(255),
    method_name VARCHAR(255),
    start_time BIGINT,
    end_time BIGINT,
    duration_ns BIGINT,
    thread_name VARCHAR(128),
    extra_info VARCHAR(512),
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 字段说明
- **id**: 主键，自增长
- **class_name**: 类名
- **method_name**: 方法名
- **start_time**: 开始时间戳（纳秒）
- **end_time**: 结束时间戳（纳秒）
- **duration_ns**: 执行耗时（纳秒）
- **thread_name**: 线程名
- **extra_info**: 额外信息
- **create_time**: 记录创建时间

### 索引建议
```sql
-- 创建性能优化索引
CREATE INDEX idx_class_method ON method_time_stat(class_name, method_name);
CREATE INDEX idx_duration ON method_time_stat(duration_ns);
CREATE INDEX idx_create_time ON method_time_stat(create_time);
CREATE INDEX idx_thread ON method_time_stat(thread_name);
```

## 常用场景

### 1. 开发环境配置

#### YAML配置文件方式
```yaml
# 开发环境 - 全量采集，详细分析
collector:
  packages: "com.your.package.*"
  samplingRate: 1.0           # 全量采集
  minDurationNs: 10000        # 低阈值
  queueCapacity: 1000         # 小队列

storage:
  batchSize: 100              # 小批量
  retentionDays: 1            # 短期保留

log:
  level: DEBUG                # 详细日志
```

#### JVM系统属性方式
```bash
java -javaagent:target/mingsha-javaagent-methodtime-0.0.1-SNAPSHOT.jar \
     -Dmingsha.agent.config.collector.packages="com.your.package.* "\
     -Dmingsha.agent.config.collector.samplingRate=1.0 \
     -Dmingsha.agent.config.collector.minDurationNs=10000 \
     -Dmingsha.agent.config.collector.queueCapacity=1000 \
     -Dmingsha.agent.config.storage.batchSize=100 \
     -Dmingsha.agent.config.storage.retentionDays=1 \
     -Dmingsha.agent.config.log.level=DEBUG \
     -jar your-app.jar
```

### 2. 生产环境配置

#### YAML配置文件方式
```yaml
# 生产环境 - 采样采集，性能优先
collector:
  packages: "com.your.package.*"
  samplingRate: 0.1           # 10%采样
  minDurationNs: 1000000      # 1ms阈值
  queueCapacity: 50000        # 大队列

storage:
  batchSize: 1000             # 大批量
  retentionDays: 7            # 保留7天

monitor:
  cpu:
    fuseThreshold: 70         # 严格限制
```

#### JVM系统属性方式
```bash
java -javaagent:target/mingsha-javaagent-methodtime-0.0.1-SNAPSHOT.jar \
     -Dmingsha.agent.config.collector.packages="com.your.package.* "\
     -Dmingsha.agent.config.collector.samplingRate=0.1 \
     -Dmingsha.agent.config.collector.minDurationNs=1000000 \
     -Dmingsha.agent.config.collector.queueCapacity=50000 \
     -Dmingsha.agent.config.storage.batchSize=1000 \
     -Dmingsha.agent.config.storage.retentionDays=7 \
     -Dmingsha.agent.config.monitor.cpu.fuseThreshold=70 \
     -jar your-app.jar
```

### 3. 性能测试配置

#### YAML配置文件方式
```yaml
# 性能测试 - 关注慢方法
collector:
  packages: "com.your.package.*"
  samplingRate: 0.5           # 50%采样
  minDurationNs: 50000        # 50微秒阈值
  queueCapacity: 100000       # 大容量

storage:
  batchSize: 2000             # 大批量
  retentionDays: 1            # 只保留1天
```

#### JVM系统属性方式
```bash
java -javaagent:target/mingsha-javaagent-methodtime-0.0.1-SNAPSHOT.jar \
     -Dmingsha.agent.config.collector.packages="com.your.package.* "\
     -Dmingsha.agent.config.collector.samplingRate=0.5 \
     -Dmingsha.agent.config.collector.minDurationNs=50000 \
     -Dmingsha.agent.config.collector.queueCapacity=100000 \
     -Dmingsha.agent.config.storage.batchSize=2000 \
     -Dmingsha.agent.config.storage.retentionDays=1 \
     -jar your-app.jar
```

## 常用查询

### 1. 慢方法分析
```sql
-- 查询平均耗时最慢的方法
SELECT 
    class_name,
    method_name,
    AVG(duration_ns) as avg_duration,
    COUNT(*) as call_count
FROM method_time_stat 
GROUP BY class_name, method_name 
ORDER BY avg_duration DESC
LIMIT 10
```

### 2. 方法调用频率
```sql
-- 查询调用频率最高的方法
SELECT 
    class_name,
    method_name,
    COUNT(*) as call_count
FROM method_time_stat 
GROUP BY class_name, method_name 
ORDER BY call_count DESC
LIMIT 10
```

### 3. 线程性能分析
```sql
-- 查询线程性能统计
SELECT 
    thread_name,
    COUNT(*) as call_count,
    AVG(duration_ns) as avg_duration
FROM method_time_stat 
GROUP BY thread_name 
ORDER BY avg_duration DESC
```

### 4. 性能趋势分析
```sql
-- 按小时分析性能趋势
SELECT 
    DATE_FORMAT(create_time, '%Y-%m-%d %H:00:00') as hour,
    COUNT(*) as call_count,
    AVG(duration_ns) as avg_duration
FROM method_time_stat 
WHERE create_time > DATEADD('DAY', -1, CURRENT_TIMESTAMP)
GROUP BY DATE_FORMAT(create_time, '%Y-%m-%d %H:00:00')
ORDER BY hour
```

## 性能与安全说明

### 性能特性
- 采集线程、写入线程、Telnet线程、监控线程均独立，主进程零干扰
- 支持批量写入、自动补偿、自动清理、CPU 熔断、线程自愈
- 全局异常捕获，保证主进程稳定
- Telnet 端口冲突自动切换，SQL 沙箱防注入

### 安全特性
- SQL 沙箱保护，禁止高危操作
- 端口冲突自动切换
- 全局异常捕获，不影响主进程
- 数据转存机制，保证数据安全

## 常见问题与FAQ

### 配置相关
- **如何动态调整采样率/采集包？**
  - 修改 agent-config.yml 后，通过 Telnet 执行 `agent reload` 即可热加载。
- **如何通过JVM参数覆盖配置？**
  - 使用 `-Dmingsha.agent.config.xxx=value` 参数，如 `-Dmingsha.agent.config.collector.samplingRate=0.5`。
- **配置覆盖的优先级是什么？**
  - JVM系统属性 > YAML配置文件 > 默认值。
- **所有配置项都支持覆盖吗？**
  - 是的，所有14个配置项都支持通过JVM系统属性覆盖。

### 数据相关
- **如何导出采集数据？**
  - Telnet 执行 `agent export /tmp/out.csv`。
- **如何保证数据不丢失？**
  - 支持本地转存与自动补偿，异常可通过 `agent errors` 查询。
- **数据库路径没配会怎样？**
  - 启动时报错并退出，必须通过JVM参数或配置文件配置 storage.h2.path。
- **内存模式和文件模式有什么区别？**
  - 内存模式（`mem:xxx`）：数据存储在内存中，进程退出即丢失，适合开发测试。
  - 文件模式（普通路径）：数据存储在磁盘文件中，持久化保存，适合生产环境。
- **如何选择内存模式还是文件模式？**
  - 开发/测试：使用内存模式，无需清理文件，重启即空。
  - 生产环境：使用文件模式，保证数据持久化，避免进程重启丢失数据。

### 扩展相关
- **如何扩展采集字段？**
  - 修改 MethodTimeRecord 及表结构，重启 agent。

## 故障排查

### 1. 常见问题

#### Agent 未启动
```bash
# 检查 JAR 文件
ls -la target/mingsha-javaagent-methodtime.jar

# 检查 Java 版本
java -version

# 检查启动日志
tail -f your-app.log
```

#### 无数据采集
```bash
# 检查配置的包名
telnet localhost 5005
agent status

# 确认目标包是否在配置范围内
# 检查采样率和阈值设置
```

#### 连接失败
```bash
# 检查端口是否开放
netstat -tlnp | grep 5005

# 检查防火墙
iptables -L | grep 5005
```

### 2. 日志分析
```bash
# 查看应用日志
tail -f your-app.log | grep mingsha-agent

# 查看系统资源
top -p $(pgrep -f your-app)
```

### 3. 性能调优
```bash
# 监控 CPU 使用率
telnet localhost 5005
agent status

# 调整配置参数
# 1. 降低采样率
# 2. 提高最小耗时阈值
# 3. 增加队列容量
```

## 配置覆盖完整示例

### 所有配置项覆盖示例
```bash
# 覆盖所有14个配置项的完整示例
java -javaagent:target/mingsha-javaagent-methodtime-0.0.1-SNAPSHOT.jar \
     -Dmingsha.agent.config.collector.packages="com.myapp.* "\
     -Dmingsha.agent.config.collector.samplingRate=0.5 \
     -Dmingsha.agent.config.collector.minDurationNs=1000000 \
     -Dmingsha.agent.config.collector.queueCapacity=20000 \
     -Dmingsha.agent.config.storage.batchSize=1000 \
     -Dmingsha.agent.config.storage.failoverThreshold=5000 \
     -Dmingsha.agent.config.storage.retentionDays=30 \
     -Dmingsha.agent.config.storage.retentionRows=2000000 \
     -Dmingsha.agent.config.storage.h2.path="./my_app_db" \
     -Dmingsha.agent.config.manage.telnet.port=5006 \
     -Dmingsha.agent.config.manage.telnet.maxThreads=2 \
     -Dmingsha.agent.config.monitor.cpu.fuseThreshold=90 \
     -Dmingsha.agent.config.monitor.healthCheckIntervalMs=10000 \
     -Dmingsha.agent.config.log.level=DEBUG \
     -jar your-app.jar
```

### 配置验证
启动后会自动显示当前配置：
```
[mingsha-agent] Current Configuration:
  Collector Packages: com.myapp.*
  Sampling Rate: 0.5
  Min Duration (ns): 1000000
  Queue Capacity: 20000
  Batch Size: 1000
  H2 Path: ./my_app_db
  Telnet Port: 5006
  CPU Fuse Threshold: 90%
  Log Level: DEBUG
```

### 测试配置覆盖功能
```bash
# 运行配置覆盖测试脚本
./bin/test-config-override.sh
```

> **提示**：更多配置覆盖详情请查看 [配置覆盖指南](配置覆盖指南.md) 